from __future__ import annotations

from typing import Iterable, Tuple
import torch


def chebyshev_eval(coeffs: Iterable[float], x: torch.Tensor, domain: Tuple[float, float]) -> torch.Tensor:
    """
    Evaluate Chebyshev series sum_{k=0}^{n} c_k T_k(t) at x using Clenshaw's algorithm.
    Coefficients are ordered [c0, c1, ..., cn].
    Domain maps x in [a, b] to t in [-1, 1].
    """
    a, b = domain
    # Map x from [a,b] to t in [-1,1]
    t = (2.0 * (x - a) / (b - a)) - 1.0
    c = list(coeffs)
    n = len(c) - 1
    if n < 0:
        return torch.zeros_like(x)
    if n == 0:
        return torch.full_like(x, float(c[0]))
    b_kplus1 = torch.zeros_like(t)
    b_kplus2 = torch.zeros_like(t)
    for k in range(n, 0, -1):
        b_k = 2.0 * t * b_kplus1 - b_kplus2 + float(c[k])
        b_kplus2 = b_kplus1
        b_kplus1 = b_k
    return t * b_kplus1 - b_kplus2 + float(c[0])


# ---- Ported Chebyshev coefficients from Encryption-friendly_LLM_Architecture (SoftmaxRemezCoeff.hpp) ----
# EXPONENTIAL_UNI_15 on input range [-8, 0]
EXP_UNI_15 = [
    0.20700192122398669790, 0.35750167900487065403, 0.23525300294553806878,
    0.12224867605933258525, 0.051879988856539190900, 0.018488698346254203451,
    0.0056582429909036822727, 0.0015139693735431566342, 0.00035935018350263406007,
    7.6568639532620301934e-5, 1.4791305605839073455e-5, 2.6121115033526511277e-6,
    4.2469233627865086904e-7, 6.3957470862877483401e-8, 8.9686029997318186944e-9,
    1.1935413088864879233e-9,
]

# INVERSE_31_0 on input range [0.08, 257] (approx 1/x)
INV_31_0 = [
    0.19645773133681095172,  -0.37743384227253540350,  0.36209283321575008519,
    -0.34703518178104683207,  0.33212448319119520155,  -0.31748675642060775106,
    0.30300903119455774775,  -0.28878635524893144680,  0.27474418682362365964,
    -0.26093065613666105348,  0.24732676899966514135,  -0.23391521820264968520,
    0.22075273245898102221,  -0.20773447051332602118,  0.19501720331340502880,
    -0.18238169592648022930,  0.17011452491527161867,  -0.15784900857644258407,
    0.14603831566692645436,  -0.13412732303730867190,  0.12278154090808640435,
    -0.11120631263965001360,  0.10033660162270940370,  -0.089074353724686575566,
    0.078695443463202744717, -0.067718451761845701721,  0.057849690534371867380,
    -0.047124144185695022378,  0.037790809563190365235, -0.027275373469717446579,
    0.018510311566803593061, -0.008154322276124930864,
]


def exp_cheb(x: torch.Tensor) -> torch.Tensor:
    x = x.clamp(-8.0, 0.0)
    return chebyshev_eval(EXP_UNI_15, x, domain=(-8.0, 0.0))


def inv_cheb(x: torch.Tensor) -> torch.Tensor:
    x = x.clamp(0.08, 257.0)
    return chebyshev_eval(INV_31_0, x, domain=(0.08, 257.0))


# ---- Tanh Chebyshev coefficients (TANH_COEFFS_63_8) on input range [-5, 5] ----
TANH_63_8 = [
    0.0000000000000000000000000000000000000000000000033200580,
    1.2628448865139472,
    0.0000000000000000000000000000000000000000000000050364594,
    -0.3815488589895728,
    0.0000000000000000000000000000000000000000000000033864224,
    0.1993220141048639,
    0.0000000000000000000000000000000000000000000000017018977,
    -0.13782596959112242,
    0.0000000000000000000000000000000000000000000000036124790,
    0.0962956229756925,
    0.0000000000000000000000000000000000000000000000054855884,
    -0.05330356448768639,
    0.0000000000000000000000000000000000000000000000036891473,
    0.03172268450532907,
    0.0000000000000000000000000000000000000000000000018542491,
    -0.02273320511676779,
    0.0000000000000000000000000000000000000000000000046836614,
    0.008120701269645956,
    0.0000000000000000000000000000000000000000000000071038474,
    -0.004514302110494799,
    0.0000000000000000000000000000000000000000000000047733511,
    0.0026905084650483656,
    0.0000000000000000000000000000000000000000000000023979393,
    -0.0019289656437958616,
    0.0000000000000000000000000000000000000000000000050513871,
    0.0013589744334692178,
    0.0000000000000000000000000000000000000000000000076585807,
    -0.0007554991771371866,
    0.0000000000000000000000000000000000000000000000051446335,
    0.00045028407755842714,
    0.0000000000000000000000000000000000000000000000025840110,
    -0.0003228342008795293,
    0.0000000000000000000000000000000000000000000000035182868,
    0.00005767273064988974,
    0.0000000000000000000000000000000000000000000000053466728,
    -0.00003206101693242622,
    0.0000000000000000000000000000000000000000000000036012664,
    0.000019108650425446244,
    0.0000000000000000000000000000000000000000000000018117755,
    -0.000013700076849105212,
    0.0000000000000000000000000000000000000000000000039017526,
    0.000009651848498443225,
    0.0000000000000000000000000000000000000000000000059420331,
    -0.000005365788861944965,
    0.0000000000000000000000000000000000000000000000040043908,
    0.0000031980577616464237,
    0.0000000000000000000000000000000000000000000000020151982,
    -0.0000022928692599982758,
    0.0000000000000000000000000000000000000000000000021486851,
    0.0000008177405051526824,
    0.0000000000000000000000000000000000000000000000032692101,
    -0.0000004522030278120799,
    0.0000000000000000000000000000000000000000000000022089231,
    0.0000002695170160864173,
    0.0000000000000000000000000000000000000000000000011134443,
    -0.00000019323205748651099,
    0.0000000000000000000000000000000000000000000000010997578,
    0.00000013531716286569774,
    0.0000000000000000000000000000000000000000000000012204437,
    -0.00000007290844827043466,
    0.0000000000000000000000000000000000000000000000005264304,
    0.00000003928283535243292,
    0.0000000000000000000000000000000000000000000000001297155,
    -0.000000029823195969367038,
]


def tanh_cheb(x: torch.Tensor) -> torch.Tensor:
    x = x.clamp(-5.0, 5.0)
    return chebyshev_eval(TANH_63_8, x, domain=(-5.0, 5.0))


